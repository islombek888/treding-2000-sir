import { IndicatorService } from './indicatorService.js';
import { MarketAnalyzer, MarketTrend } from './marketAnalyzer.js';
import { RiskEvaluator } from './riskEvaluator.js';
import {} from './alertService.js';
export class SignalEngine {
    /**
     * Processes new market data and determines if a signal should be triggered
     */
    static process(candles) {
        if (candles.length < 50)
            return; // Need enough data for EMAs
        const state = MarketAnalyzer.analyze(candles);
        const closes = candles.map(c => c.close);
        const rsi = IndicatorService.calculateRSI(closes, 14);
        const divergence = IndicatorService.detectDivergence(closes, rsi);
        const evaluation = RiskEvaluator.evaluate(state, divergence);
        if (evaluation.score >= 70 && state.trend !== MarketTrend.RANGING) {
            const lastClose = closes[closes.length - 1];
            // Expected move (Simplified: 50 pips or 2x ATR)
            const expectedPips = Math.max(50, Math.round(state.atr * 2 * 100));
            const signal = {
                symbol: 'XAUUSD', // Default for this legacy engine
                direction: state.trend === MarketTrend.BULLISH ? 'BUY' : 'SELL',
                pips: expectedPips,
                confidence: evaluation.score,
                reason: [this.generateReason(state, divergence)],
                price: lastClose,
                atr: state.atr,
                strategy: 'Institutional Momentum Model'
            };
            console.log("Signal generated by SignalEngine (legacy):", signal);
        }
    }
    static generateReason(state, divergence) {
        const reasons = [];
        if (state.trend === MarketTrend.BULLISH)
            reasons.push("Strong upward trend confirmed by EMAs");
        if (state.trend === MarketTrend.BEARISH)
            reasons.push("Strong downward trend confirmed by EMAs");
        if (divergence !== 'NONE')
            reasons.push(`RSI ${divergence} divergence detected`);
        if (state.isVolatilityExpanding)
            reasons.push("Volatility expansion (ATR) detected");
        if (state.hasBOS)
            reasons.push("Market structure shift (BOS) identified");
        if (state.hasLiquiditySweep)
            reasons.push("Liquidity sweep confirmed");
        return reasons.join(", ");
    }
}
//# sourceMappingURL=signalEngine.js.map